
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>solr初读-1 | youfei&#39;s blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="fei you">
    
    <meta name="description" content="看Solr 的时候偶尔看到了一个博客，写的太和俺的胃口了,加到友情链接里面，嘿嘿
zyb243380456的专栏">
    
    
    
    
    <link rel="alternative" href="/atom.xml" title="youfei&#39;s blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="youfei&#39;s blog" title="youfei&#39;s blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="youfei&#39;s blog">youfei&#39;s blog</a></h1>
				<h2 class="blog-motto">Good good study</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:youfei.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/03/06/solr-g-1/" title="solr初读-1" itemprop="url">solr初读-1</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://youfei.github.io" title="fei you">fei you</a>
    </p>
  <p class="article-time">
    <time datetime="2014-03-06T02:06:16.000Z" itemprop="datePublished">3月 6 2014</time>
    更新日期:<time datetime="2014-03-06T06:13:20.000Z" itemprop="dateModified">3月 6 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-solr-"><span class="toc-number">1.</span> <span class="toc-text">1.solr认识</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-web-solr-"><span class="toc-number">2.</span> <span class="toc-text">2.快速的为你的web应用提供solr全文检索服务</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tomcat-uriencoding"><span class="toc-number">2.1.</span> <span class="toc-text">Tomcat URIEncoding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-jar-"><span class="toc-number">2.2.</span> <span class="toc-text">需要的jar:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-solr-home-"><span class="toc-number">2.3.</span> <span class="toc-text">的主要目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#solr-servlet-solr-home-"><span class="toc-number">2.4.</span> <span class="toc-text">solr如何与servlet容器相关联[配置solr.home]</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#3-solr-"><span class="toc-number">3.</span> <span class="toc-text">3.solr相关包的概要</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-jar-"><span class="toc-number">3.1.</span> <span class="toc-text">首先需要的jar包有:</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#apache-solr-core-3-2-0-jar-"><span class="toc-number">3.1.1.</span> <span class="toc-text">apache-solr-core-3.2.0.jar;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#org-apache-solr-highlight"><span class="toc-number">3.1.2.</span> <span class="toc-text">org.apache.solr.highlight</span></a></li></ol></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#4-corecontainer-"><span class="toc-number">4.</span> <span class="toc-text">4.如何配置多实例的CoreContainer容器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-solr-"><span class="toc-number">5.</span> <span class="toc-text">5.分布式solr服务的搭建配置方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-solr-http-"><span class="toc-number">6.</span> <span class="toc-text">6.一个请求solr服务的http请求的执行顺序</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-solr-core-code-"><span class="toc-number">7.</span> <span class="toc-text">7.solr分布式索引分发的全过程以及中间core code:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-solrj-solrcore-api-"><span class="toc-number">8.</span> <span class="toc-text">7.solrj提供了控制solrcore容器的api包括范围配置信息等</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">9.</span> <span class="toc-text">参考</span></a></li></ol>
		</div>
		
		<p>看Solr 的时候偶尔看到了一个博客，写的太和俺的胃口了,加到友情链接里面，嘿嘿</br>
<a href="http://blog.csdn.net/zyb243380456/article/details/7225768" target="_blank">zyb243380456的专栏</a></p>
<a id="more"></a>


<h1 id="1-solr-">1.solr认识</h1>
<p>solr是基于lucene开发包而搭建起来的一个依赖于Servlet容器的一个全文检索组件，他可以为自己的
web应用提供简单的检索服务，也可以搭建复杂的集群环境进行全文检索，例如如果索引文件很大大概
有7-90GB的索引文件就需要做分布式了应为这样的数据量一台机器的检索数据的速度太慢，如果需要
进行集群demo测试可以在本机多开启几个web应用服务器就可以了。</p>
<p><strong>Solr4 结构图</strong>
<img src="http://img1.51cto.com/attachment/201304/164703786.png" alt="Solr4 结构图*"></p>
<hr>
<h1 id="2-web-solr-">2.快速的为你的web应用提供solr全文检索服务</h1>
<h2 id="tomcat-uriencoding">Tomcat URIEncoding</h2>
<p><strong>server.xml</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">Connector</span> <span class="attribute">port</span>=<span class="value">"8080"</span> <span class="attribute">protocol</span>=<span class="value">"HTTP/1.1"</span>  
           <span class="attribute">connectionTimeout</span>=<span class="value">"20000"</span>  
           <span class="attribute">redirectPort</span>=<span class="value">"8443"</span> <span class="attribute">URIEncoding</span>=<span class="value">"UTF-8"</span>/&gt;</span>
</pre></td></tr></table></figure>

<h2 id="-jar-">需要的jar:</h2>
<p><strong>apache-solr-core-3.2.0.jar</strong> </br>
<strong>apache-solr-solrj-3.2.0.jar</strong>--&gt;用于提供测试solr全文检索的java客户端</p>
<h2 id="-solr-home-">如何配置你的<code>solr.home</code>的主要目录结构</h2>
<p> 可以以任意名字的目录进行配置, 但是在这个目录的里面需要按照solr的要求来配置
 在xxx目录里面有<strong>bin</strong>, <strong>data</strong>, <strong>conf</strong>和<strong>solr.xml</strong>三个目录和一个配置文件,这个配置文件用于
 配置<strong>CoreContainer</strong>容器的多实例通过这个配置实现</p>
<p> 在<code>bin</code>里面是solr插件的第三方jar包; 也就是你需要为solr添加的插件包放在这个里面</br></p>
<p> <code>data</code>下面有index,和spellcheck两个目录分别是存放索引文件和拼写检查的什么东西</br></p>
<p> 在<code>conf</code>下面全部是与当前solrcore实例相关的一些配置文件，例如 <code>solrconfig.xml</code>, <code>schema.xml</code></br></p>
<p> <code>scripts.conf</code>这三个文件是最重要的;</p>
<ul>
<li>第一个用于配置当前solrcore如何对外提供全文检索服务</li>
<li>第二个用于配置当前solrcore实例的索引文档的格式以及文档的字段信息</li>
<li>第三个用于做solr分布式索引分发以及同步的配置文件</li>
</ul>
<h2 id="solr-servlet-solr-home-">solr如何与servlet容器相关联[配置solr.home]</h2>
<blockquote>
<p>上面已经配置好solr的木要目录结构然后只要让solrDispatchFilter在实例化的时候找到这个目录就能够初始化我们的solr.home了</br></p>
<p>可以在过滤器或者监听器构造函数中通过设置jvm系统参数的形式</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>  System<span class="preprocessor">.setProperty</span>(<span class="string">"solr.solr.home"</span>,<span class="string">"dir"</span>)<span class="comment">;</span>
</pre></td></tr></table></figure>

<blockquote>
<p>web.xml中进行描述,上面已经复制过通过在tomcat的JNDI容器中进行指定就是那个context.xml中</p>
</blockquote>
<p>在web.xml中配置SolrDispatchFilter.java</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="comment">&lt;!-- 过滤所有与solr相关的http请求  --&gt;</span>
<span class="tag">&lt;<span class="title">filter</span>&gt;</span>
	<span class="tag">&lt;<span class="title">filter-name</span>&gt;</span>SolrRequestFilter<span class="tag">&lt;/<span class="title">filter-name</span>&gt;</span>
	<span class="tag">&lt;<span class="title">filter-class</span>&gt;</span>org.apache.solr.servlet.SolrDispatchFilter<span class="tag">&lt;/<span class="title">filter-class</span>&gt;</span>
	<span class="tag">&lt;<span class="title">init-param</span>&gt;</span>
	        <span class="comment">&lt;!-- 通过一特定开头的字符标志需要solr服务 --&gt;</span>
		<span class="tag">&lt;<span class="title">param-name</span>&gt;</span>path-prefix<span class="tag">&lt;/<span class="title">param-name</span>&gt;</span>
		<span class="tag">&lt;<span class="title">param-value</span>&gt;</span>solrservice<span class="tag">&lt;/<span class="title">param-value</span>&gt;</span>
	<span class="tag">&lt;/<span class="title">init-param</span>&gt;</span>
<span class="tag">&lt;/<span class="title">filter</span>&gt;</span>
<span class="tag">&lt;<span class="title">filter-mapping</span>&gt;</span>
 <span class="tag">&lt;<span class="title">filter-name</span>&gt;</span>SolrRequestFilter<span class="tag">&lt;/<span class="title">filter-name</span>&gt;</span>
 <span class="tag">&lt;<span class="title">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="title">url-pattern</span>&gt;</span>
<span class="tag">&lt;/<span class="title">filter-mapping</span>&gt;</span>
</pre></td></tr></table></figure>

<hr>
<h1 id="3-solr-">3.solr相关包的概要</h1>
<h2 id="-jar-">首先需要的jar包有:</h2>
<h3 id="apache-solr-core-3-2-0-jar-">apache-solr-core-3.2.0.jar;</h3>
<p>这是jar包中所包含的包:</p>
<blockquote>
<p>org.apache.solr.analysis</br></p>
</blockquote>
<p>这个包主要解决分词问题，学习solr之前必须对lucene的简单结构
进行了解如何分词lucene中已经提到过</p>
<blockquote>
<p>org.apache.solr.client.solrj.embedded</br></p>
</blockquote>
<p>solrj主要提供方便的方式去应用solr全文检索的功能</p>
<blockquote>
<p>org.apache.solr.core</br></p>
</blockquote>
<p>包含的主要类介绍</br>
org.apache.solr.core.CoreContainer.java,</br>
org.apache.solr.core.Config.java,</br>
org.apache.solr.core.SolrConfig.java,</br>
org.apache.solr.core.SolrCore.java</br>
org.apache.solr.core.CoreDescriptor.java,</br>
org.apache.solr.core.DirectoryFactory.java,</br>
org.apache.solr.core.SolrResourceLoader.java</p>
<p>不管你有多少个solrcore实例那么solrcore的实例都会存放在我们的CoreContainer的</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="keyword">protected</span> final <span class="keyword">Map</span>&lt;<span class="typename">String</span>, SolrCore&gt; cores = <span class="keyword">new</span> LinkedHashMap&lt;<span class="typename">String</span>, SolrCore&gt;();
</pre></td></tr></table></figure>

<p>这个属性中也就是用于保存solrcore实例，那么solrCore是如何被创建的，他是根据SolrConfig创建的</br>
<strong>solrConfig</strong>继承自Config类Config类提供的xPath的方式去解析xml文件</br>
<strong>solrConfig</strong>对应到我们的SolrConfig.xml文件，然后SolrResourceLoader是用来加载配置文件的并且用于定位solr.home</br>
<strong>solr.home</strong>在SolrResourceLoader是怎么定位到<code>solr.home</code>的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="code"><pre><span class="keyword">public</span> static <span class="built_in">String</span> locateSolrHome() {
    <span class="built_in">String</span> home <span class="subst">=</span> <span class="built_in">null</span>;
    <span class="comment">// 功过JNDI的方式定位到solrHome的主要目录</span>
    <span class="comment">// 他可以在web.xml中这样配置</span>
    <span class="comment">//&lt;env-entry&gt;</span>
	<span class="comment">//&lt;env-entry-name&gt;solr/home&lt;/env-entry-name&gt;</span>
	<span class="comment">//&lt;env-entry-value&gt;C:\\apache-tomcat-6.0.35-windows-x64\\apache-tomcat-6.0.35\\webapps\\solr&lt;/env-entry-value&gt;</span>
	<span class="comment">//&lt;env-entry-type&gt;java.lang.String&lt;/env-entry-type&gt;</span>
    <span class="comment">//&lt;/env-entry&gt;</span>
    try {
      Context c <span class="subst">=</span> <span class="literal">new</span> InitialContext();
      home <span class="subst">=</span> (<span class="built_in">String</span>)c<span class="built_in">.</span>lookup(<span class="string">"java:comp/env/"</span><span class="subst">+</span>project<span class="subst">+</span><span class="string">"/home"</span>);
      <span class="keyword">log</span><span class="built_in">.</span>info(<span class="string">"Using JNDI solr.home: "</span><span class="subst">+</span>home );
    } catch (NoInitialContextException e) {
      <span class="keyword">log</span><span class="built_in">.</span>info(<span class="string">"JNDI not configured for "</span><span class="subst">+</span>project<span class="subst">+</span><span class="string">" (NoInitialContextEx)"</span>);
    } catch (NamingException e) {
      <span class="keyword">log</span><span class="built_in">.</span>info(<span class="string">"No /"</span><span class="subst">+</span>project<span class="subst">+</span><span class="string">"/home in JNDI"</span>);
    } catch( RuntimeException ex ) {
      <span class="keyword">log</span><span class="built_in">.</span>warn(<span class="string">"Odd RuntimeException while testing for JNDI: "</span> <span class="subst">+</span> ex<span class="built_in">.</span>getMessage());
    } 
    
    <span class="comment">// 如果JNDI没有找到主要目录的话就会尝试在System.getProperty("solr.solr.home");</span>
    <span class="comment">// 也就是JVM的系统参数中进行一个查找只要是在同一个JVM中都是可以找到的</span>
    <span class="comment">// 你也可以在某个监听器或者过滤器中指定solrhome他是这样指定的</span>
    <span class="comment">// 需要注意的是你的过滤器必须要在SolrDispatchFilter.java这个过滤器之前因为</span>
    <span class="comment">// 容器初始化过滤器的时候是根据配置文件的顺序进行实例话的</span>
    <span class="comment">// 在SolrDispatchFilter.java过滤器实例化的时候进行了很多的solr初始化服务包括容器的初始化等</span>
    <span class="comment">// 所以必须要在这个过滤器实例化之前指定solrhome的主要目录</span>
    <span class="comment">// System.setProperty("solr.solr.home","dir");</span>
    <span class="keyword">if</span>( home <span class="subst">==</span> <span class="built_in">null</span> ) {
      <span class="built_in">String</span> prop <span class="subst">=</span> project <span class="subst">+</span> <span class="string">".solr.home"</span>;
      home <span class="subst">=</span> System<span class="built_in">.</span>getProperty(prop);
      <span class="keyword">if</span>( home <span class="subst">!=</span> <span class="built_in">null</span> ) {
        <span class="keyword">log</span><span class="built_in">.</span>info(<span class="string">"using system property "</span><span class="subst">+</span>prop<span class="subst">+</span><span class="string">": "</span> <span class="subst">+</span> home );
      }
    }
    
    <span class="comment">// 如果上面的两种方式都没有找到就会到web应用的主目录下就行查找</span>
    <span class="comment">// 如果你的web应用名字叫test的话他就到test目录下去找solr这个目录</span>
    <span class="keyword">if</span>( home <span class="subst">==</span> <span class="built_in">null</span> ) {
      home <span class="subst">=</span> project <span class="subst">+</span> <span class="string">'/'</span>;
      <span class="keyword">log</span><span class="built_in">.</span>info(project <span class="subst">+</span> <span class="string">" home defaulted to '"</span> <span class="subst">+</span> home <span class="subst">+</span> <span class="string">"' (could not find system property or JNDI)"</span>);
    }
    <span class="keyword">return</span> normalizeDir( home );
  }
</pre></td></tr></table></figure>

<p>定位到<code>solr.home</code>的主要目录后也就可以根据特定的目录层次结构进行加载配置文件然后实例容器然后向容器中添加solrcore实例了。</br></p>
<p><strong>CoreDescriptor</strong>这个类主要是用来描述一个solrcore实例特征的相当于介绍这个solrcore有几个处理器，并且
有chema.xml文件在那个位置然后这个solrcore的名字叫什么他的数据索引文件存放在哪个位置等...</br>
<strong>DirectoryFactory</strong>这个类对应的lucene中的FSDirectory他是找到所有索引文件所在的目录。</br></p>
<blockquote>
<p>org.apache.solr.handler</p>
</blockquote>
<p>这个包中有提供了大部分solr提供的服务功能的实现</br>
处理器也就是处理提出的各种不同的solr的全文检索服务要求 </br>
包括crud和控制我们的容器对象和solrcore实例对象的一些处理方式</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>org<span class="preprocessor">.apache</span><span class="preprocessor">.solr</span><span class="preprocessor">.handler</span><span class="preprocessor">.admin</span><span class="preprocessor">.AdminHandlers</span><span class="preprocessor">.java</span>
</pre></td></tr></table></figure>

<p>AdminHandlers相当于<strong>solr.home</strong>的主人，他将掌管这个家庭的成员也就是solrcore实例，
等多方面的功能。</p>
<blockquote>
<p>org.apache.solr.handler.ReplicationHandler.java</p>
</blockquote>
<p>ReplicationHandler需要在做solr分布式的时候用到，在默认的情况下solr的<code>solrconfig.xml</code></br></p>
<p>主机和从机上的索引文件是一样的他是通过他们两个之间的版本号的差别来进行一个两个索引库之间的索引同步操作来实现solr的分布式索引库的维护，这个目的主要是为了提供更好和更快速的检索服务，</br></p>
<p>主机用于提供维护操作，而从机用于提供检索服务，我们还可以提供多个这样的组合,并且对外提供一台检索服务的机器,然后当有查询请求的时候,通过这台主机将查询语句发送到下面所有的从机上去.然后将这些查询结构做一个统一，</br></p>
<p>这样的功能solr已经提供的非常好了，只是如何去搭建大的分布式检索架构需要考虑一下主机的配置:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">requestHandler</span> <span class="attribute">name</span>=<span class="value">"/replication"</span> <span class="attribute">class</span>=<span class="value">"solr.ReplicationHandler"</span> &gt;</span>
      <span class="tag">&lt;<span class="title">lst</span> <span class="attribute">name</span>=<span class="value">"master"</span>&gt;</span> 
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"replicateAfter"</span>&gt;</span>commit<span class="tag">&lt;/<span class="title">str</span>&gt;</span> <span class="comment">&lt;!--在索引分发后自动提交 --&gt;</span>
	    <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"httpConnTimeout"</span>&gt;</span>50000000<span class="tag">&lt;/<span class="title">str</span>&gt;</span> <span class="comment">&lt;!-- 当索引分连接达到这么长的时间后连接超时--&gt;</span>
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"httpReadTimeout"</span>&gt;</span>10000000<span class="tag">&lt;/<span class="title">str</span>&gt;</span>  <span class="comment">&lt;!-- 当读取索引文件达到这个时间的时候操作超时--&gt;</span>
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"confFiles"</span>&gt;</span>schema.xml,stopwords.txt,elevate.xml<span class="tag">&lt;/<span class="title">str</span>&gt;</span> <span class="comment">&lt;!-- 当有从机有要求和主机做同步的时候需要分发的配置文件 --&gt;</span>
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"commitReserveDuration"</span>&gt;</span>00:05:00<span class="tag">&lt;/<span class="title">str</span>&gt;</span> <span class="comment">&lt;!-- 提交受保护的时间段长度 --&gt;</span>
        <span class="tag">&lt;/<span class="title">lst</span>&gt;</span>  
  <span class="tag">&lt;/<span class="title">requestHandler</span>&gt;</span>
  从机的配置:
  <span class="tag">&lt;<span class="title">requestHandler</span> <span class="attribute">name</span>=<span class="value">"/replication"</span> <span class="attribute">class</span>=<span class="value">"solr.ReplicationHandler"</span> &gt;</span>
      <span class="tag">&lt;<span class="title">lst</span> <span class="attribute">name</span>=<span class="value">"slave"</span>&gt;</span> 
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"masterUrl"</span>&gt;</span>http://localhost:8080/mysolr/collection1/replication<span class="tag">&lt;/<span class="title">str</span>&gt;</span>
	    <span class="comment">&lt;!--translate is:http://host_name:port/webapp_name/solrcore_name/replicationHandler_name/ --&gt;</span>
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"pollInterval"</span>&gt;</span>00:05:00<span class="tag">&lt;/<span class="title">str</span>&gt;</span><span class="comment">&lt;!-- 间隔多长时间到master上去检测索引的version和generation--&gt;</span>   
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"compression"</span>&gt;</span>internal<span class="tag">&lt;/<span class="title">str</span>&gt;</span> 
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"httpConnTimeout"</span>&gt;</span>50000000<span class="tag">&lt;/<span class="title">str</span>&gt;</span> 
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"httpReadTimeout"</span>&gt;</span>10000000<span class="tag">&lt;/<span class="title">str</span>&gt;</span> 
           <span class="comment">&lt;!--  &lt;str name="httpBasicAuthUser"&gt;123&lt;/str&gt; 
           &lt;str name="httpBasicAuthPassword"&gt;123&lt;/str&gt; --&gt;</span><span class="comment">&lt;!-- 为了安全可以设置可以进行这些操作的请求的密码只有密码正确的请求才能执行分发操作--&gt;</span>
         <span class="tag">&lt;/<span class="title">lst</span>&gt;</span>  
     <span class="tag">&lt;/<span class="title">requestHandler</span>&gt;</span>
</pre></td></tr></table></figure>

<blockquote>
<p>org.apache.solr.handler.RequestHandlerBase.java</p>
</blockquote>
<p>他是所有Handler的基类,他提供了最基本的操作方式</br>
其中重要的方法:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
</pre></td><td class="code"><pre><span class="comment">// 用于处理处理solr的服务请求操作</span>
<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequest</span>(SolrQueryRequest req, SolrQueryResponse rsp) {
    numRequests++;
    <span class="keyword">try</span> {
      SolrPluginUtils.setDefaults(req,defaults,appends,invariants);
      rsp.setHttpCaching(httpCaching);
      handleRequestBody( req, rsp );
      <span class="comment">// count timeouts</span>
      NamedList header = rsp.getResponseHeader();
      <span class="keyword">if</span>(header != <span class="keyword">null</span>) {
        Object partialResults = header.get(<span class="string">"partialResults"</span>);
        <span class="keyword">boolean</span> timedOut = partialResults == <span class="keyword">null</span> ? <span class="keyword">false</span> : (Boolean)partialResults;
        <span class="keyword">if</span>( timedOut ) {
          numTimeouts++;
          rsp.setHttpCaching(<span class="keyword">false</span>);
        }
      }
    } <span class="keyword">catch</span> (Exception e) {
      SolrException.log(SolrCore.log,e);
      <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ParseException) {
        e = <span class="keyword">new</span> SolrException(SolrException.ErrorCode.BAD_REQUEST, e);
      }
      rsp.setException(e);
      numErrors++;
    }
    totalTime += rsp.getEndTime() - req.getStartTime();
  }


<span class="comment">// 这个方法是一个抽象方法也就是真正的实现实在重写这个方法的子类身上进行实现了</span>
<span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">handleRequestBody</span>( SolrQueryRequest req, SolrQueryResponse rsp ) <span class="keyword">throws</span> Exception;
<span class="comment">// 在replicationHandler中的实现:</span>
 <span class="annotation">@Override</span>
  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequestBody</span>(SolrQueryRequest req, SolrQueryResponse rsp) <span class="keyword">throws</span> Exception {
    rsp.setHttpCaching(<span class="keyword">false</span>);
    <span class="keyword">final</span> SolrParams solrParams = req.getParams();
    String command = solrParams.get(COMMAND);<span class="comment">// 得到与这个solr实例需要进行分布式操作的命令</span>
    <span class="keyword">if</span> (command == <span class="keyword">null</span>) {
      rsp.add(STATUS, OK_STATUS);
      rsp.add(<span class="string">"message"</span>, <span class="string">"No command"</span>);
      <span class="keyword">return</span>;
    }
    <span class="comment">// This command does not give the current index version of the master</span>
    <span class="comment">// 这个命令不提供当前主机的索引版本的信息</span>
    <span class="comment">// It gives the current 'replicateable' index version</span>
    <span class="comment">// 他提供当前需要复制的索引版本信息</span>
   <span class="keyword">if</span> (command.equals(CMD_INDEX_VERSION)) {
      IndexCommit commitPoint = indexCommitPoint;  <span class="comment">// make a copy so it won't change</span>
      <span class="keyword">if</span> (commitPoint != <span class="keyword">null</span> && replicationEnabled.get()) {
        <span class="comment">//</span>
        <span class="comment">// There is a race condition here.  The commit point may be changed / deleted by the time</span>
        <span class="comment">// we get around to reserving it.  This is a very small window though, and should not result</span>
        <span class="comment">// in a catastrophic failure, but will result in the client getting an empty file list for</span>
        <span class="comment">// the CMD_GET_FILE_LIST command.</span>
        <span class="comment">//</span>
        core.getDeletionPolicy().setReserveDuration(commitPoint.getVersion(), reserveCommitDuration);
        rsp.add(CMD_INDEX_VERSION, commitPoint.getVersion());
        rsp.add(GENERATION, commitPoint.getGeneration());
      } <span class="keyword">else</span> {
        <span class="comment">// This happens when replication is not configured to happen after startup and no commit/optimize</span>
        <span class="comment">// has happened yet.</span>
        rsp.add(CMD_INDEX_VERSION, <span class="number">0</span>L);
        rsp.add(GENERATION, <span class="number">0</span>L);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(CMD_GET_FILE)) {
      getFileStream(solrParams, rsp);
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(CMD_GET_FILE_LIST)) {
      getFileList(solrParams, rsp);
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(CMD_BACKUP)) {
      doSnapShoot(<span class="keyword">new</span> ModifiableSolrParams(solrParams), rsp,req);
      rsp.add(STATUS, OK_STATUS);
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(CMD_FETCH_INDEX)) {
      String masterUrl = solrParams.get(MASTER_URL);
      <span class="keyword">if</span> (!isSlave && masterUrl == <span class="keyword">null</span>) {
        rsp.add(STATUS,ERR_STATUS);
        rsp.add(<span class="string">"message"</span>,<span class="string">"No slave configured or no 'masterUrl' Specified"</span>);
        <span class="keyword">return</span>;
      }
      <span class="keyword">final</span> SolrParams paramsCopy = <span class="keyword">new</span> ModifiableSolrParams(solrParams);
      <span class="keyword">new</span> Thread() {
        <span class="annotation">@Override</span>
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {
          doFetch(paramsCopy);
        }
      }.start();
      rsp.add(STATUS, OK_STATUS);
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(CMD_DISABLE_POLL)) {
      <span class="keyword">if</span> (snapPuller != <span class="keyword">null</span>){
        snapPuller.disablePoll();
        rsp.add(STATUS, OK_STATUS);
      } <span class="keyword">else</span> {
        rsp.add(STATUS, ERR_STATUS);
        rsp.add(<span class="string">"message"</span>,<span class="string">"No slave configured"</span>);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(CMD_ENABLE_POLL)) {
      <span class="keyword">if</span> (snapPuller != <span class="keyword">null</span>){
        snapPuller.enablePoll();
        rsp.add(STATUS, OK_STATUS);
      }<span class="keyword">else</span> {
        rsp.add(STATUS,ERR_STATUS);
        rsp.add(<span class="string">"message"</span>,<span class="string">"No slave configured"</span>);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(CMD_ABORT_FETCH)) {
      <span class="keyword">if</span> (snapPuller != <span class="keyword">null</span>){
        snapPuller.abortPull();
        rsp.add(STATUS, OK_STATUS);
      } <span class="keyword">else</span> {
        rsp.add(STATUS,ERR_STATUS);
        rsp.add(<span class="string">"message"</span>,<span class="string">"No slave configured"</span>);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(CMD_FILE_CHECKSUM)) {
      <span class="comment">// this command is not used by anyone</span>
      getFileChecksum(solrParams, rsp);
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(CMD_SHOW_COMMITS)) {
      rsp.add(CMD_SHOW_COMMITS, getCommits());
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(CMD_DETAILS)) {
      rsp.add(CMD_DETAILS, getReplicationDetails(solrParams.getBool(<span class="string">"slave"</span>,<span class="keyword">true</span>)));
      RequestHandlerUtils.addExperimentalFormatWarning(rsp);
    } <span class="keyword">else</span> <span class="keyword">if</span> (CMD_ENABLE_REPL.equalsIgnoreCase(command)) {
      replicationEnabled.set(<span class="keyword">true</span>);
      rsp.add(STATUS, OK_STATUS);
   } <span class="keyword">else</span> <span class="keyword">if</span> (CMD_DISABLE_REPL.equalsIgnoreCase(command)) {
     replicationEnabled.set(<span class="keyword">false</span>);
     rsp.add(STATUS, OK_STATUS);
   }
  }
</pre></td></tr></table></figure>

<h3 id="org-apache-solr-highlight">org.apache.solr.highlight</h3>
<p>为检索到的文本提供高亮服务的包;</p>
<blockquote>
<p>org.apache.solr.request</p>
</blockquote>
<p>这个包主要通过<code>org.apache.solr.servlet.SolrRequestParser.java</code>类
根据HttpServletRequest对象的请求参数分析成符合solr应用的请求参数</br>
主要方法是:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre> <span class="keyword">public</span> SolrQueryRequest <span class="title">parse</span>( SolrCore core, String path, HttpServletRequest req ) throws Exception
  {
    SolrRequestParser parser = standard;
    
    <span class="comment">// TODO -- in the future, we could pick a different parser based on the request</span>
    
    <span class="comment">// Pick the parser from the request...</span>
    ArrayList&lt;ContentStream&gt; streams = <span class="keyword">new</span> ArrayList&lt;ContentStream&gt;(<span class="number">1</span>);
    SolrParams <span class="keyword">params</span> = parser.parseParamsAndFillStreams( req, streams );
    SolrQueryRequest sreq = buildRequestFrom( core, <span class="keyword">params</span>, streams );

    <span class="comment">// Handlers and login will want to know the path. If it contains a ':'</span>
    <span class="comment">// the handler could use it for RESTful URLs</span>
    sreq.getContext().put( <span class="string">"path"</span>, path );<span class="comment">// 在一个solr的请求处理中也有solr请求的上下文</span>
    <span class="comment">// 应为处理这个请求的话这个请求将会被当作很多发放的参数所以设置一个方法的上下文环境</span>
    <span class="comment">// 保存许多很重要的执行信息</span>
    <span class="keyword">return</span> sreq;
}
</pre></td></tr></table></figure>

<blockquote>
<p>org.apache.solr.response</p>
</blockquote>
<p>关于solr的响应的信息的封装</p>
<blockquote>
<p>org.apache.solr.schema</p>
</blockquote>
<p>对应到封装schema.xml这个里面提供的一些功能的实现</p>
<blockquote>
<p>org.apache.solr.search
org.apache.solr.servlet
org.apache.solr.servlet.SolrDispatchFilter.java</p>
</blockquote>
<p>这个类是开启solr服务的关键过滤器一般需要在web.xml部署描述符中进行配置后
才能够提供solr全文检索服务,他的doFilter方法是所有solr服务的入口。</p>
<blockquote>
<p>org.apache.solr.spelling
org.apache.solr.update
org.apache.solr.util</p>
</blockquote>
<hr>
<h1 id="4-corecontainer-">4.如何配置多实例的CoreContainer容器</h1>
<p>在solr的主目录下找到solr.xml进行配置就行了然后指定好solrcore
实例子所在的索引库以及配置还有依赖包所在的目录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="tag">&lt;<span class="title">solr</span> <span class="attribute">persistent</span>=<span class="value">"false"</span>&gt;</span>
  <span class="comment">&lt;!--
  adminPath: RequestHandler path to manage cores.
  管理员path:请求处理器所映射的管理路径然后去管理容器中的solrcore实例
    If 'null' (or absent), cores will not be manageable via request handler
    如果是null或者缺省的话,容器中的实例将不能通过请求处理器进行有效的管理
    也就是同一个web应用下面有多个solrcore的应用在检索的时候需要指定你需要检索
    的是那个solrcore:
    http://host_name:port/webapp_name/solrcore_name/admin/cores/ 
    这样就可以进行管理容器中的solrcore实例
  --&gt;</span>
  <span class="tag">&lt;<span class="title">cores</span> <span class="attribute">adminPath</span>=<span class="value">"/admin/cores"</span> <span class="attribute">defaultCoreName</span>=<span class="value">"collection1"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">core</span> <span class="attribute">name</span>=<span class="value">"collection1"</span> <span class="attribute">instanceDir</span>=<span class="value">"."</span> /&gt;</span>
    <span class="tag">&lt;<span class="title">core</span> <span class="attribute">name</span>=<span class="value">"collection2"</span> <span class="attribute">instanceDir</span>=<span class="value">"f:\\hh"</span> /&gt;</span>
  <span class="tag">&lt;/<span class="title">cores</span>&gt;</span>
<span class="tag">&lt;/<span class="title">solr</span>&gt;</span>
</pre></td></tr></table></figure>

<hr>
<h1 id="5-solr-">5.分布式solr服务的搭建配置方式</h1>
<p>首先找到需要进行分布式应用的solrcore实例的配置所在目录然后在solrconfig.xml中</br>
 将用于处理分布式服务的请求处理器的配置加上去,还需要在scripts.conf中进行指定一些
 信息就可以了</p>
<blockquote>
<p>master</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">requestHandler</span> <span class="attribute">name</span>=<span class="value">"/replication"</span> <span class="attribute">class</span>=<span class="value">"solr.ReplicationHandler"</span> &gt;</span>
      <span class="tag">&lt;<span class="title">lst</span> <span class="attribute">name</span>=<span class="value">"master"</span>&gt;</span> 
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"replicateAfter"</span>&gt;</span>commit<span class="tag">&lt;/<span class="title">str</span>&gt;</span> <span class="comment">&lt;!--在索引分发后自动提交 --&gt;</span>
	    <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"httpConnTimeout"</span>&gt;</span>50000000<span class="tag">&lt;/<span class="title">str</span>&gt;</span> <span class="comment">&lt;!-- 当索引分连接达到这么长的时间后连接超时--&gt;</span>
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"httpReadTimeout"</span>&gt;</span>10000000<span class="tag">&lt;/<span class="title">str</span>&gt;</span>  <span class="comment">&lt;!-- 当读取索引文件达到这个时间的时候操作超时--&gt;</span>
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"confFiles"</span>&gt;</span>schema.xml,stopwords.txt,elevate.xml<span class="tag">&lt;/<span class="title">str</span>&gt;</span> <span class="comment">&lt;!-- 当有从机有要求和主机做同步的时候需要分发的配置文件 --&gt;</span>
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"commitReserveDuration"</span>&gt;</span>00:05:00<span class="tag">&lt;/<span class="title">str</span>&gt;</span> <span class="comment">&lt;!-- 提交受保护的时间段长度 --&gt;</span>
        <span class="tag">&lt;/<span class="title">lst</span>&gt;</span>  
  <span class="tag">&lt;/<span class="title">requestHandler</span>&gt;</span>
</pre></td></tr></table></figure>

<blockquote>
<p>slave</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre>    <span class="tag">&lt;<span class="title">requestHandler</span> <span class="attribute">name</span>=<span class="value">"/replication"</span> <span class="attribute">class</span>=<span class="value">"solr.ReplicationHandler"</span> &gt;</span>
      <span class="tag">&lt;<span class="title">lst</span> <span class="attribute">name</span>=<span class="value">"slave"</span>&gt;</span> 
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"masterUrl"</span>&gt;</span>http://localhost:8080/mysolr/collection1/replication<span class="tag">&lt;/<span class="title">str</span>&gt;</span>
	    <span class="comment">&lt;!--translate is:http://host_name:port/webapp_name/solrcore_name/replicationHandler_name/ --&gt;</span>
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"pollInterval"</span>&gt;</span>00:05:00<span class="tag">&lt;/<span class="title">str</span>&gt;</span><span class="comment">&lt;!-- 间隔多长时间到master上去检测索引的version和generation--&gt;</span>   
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"compression"</span>&gt;</span>internal<span class="tag">&lt;/<span class="title">str</span>&gt;</span> 
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"httpConnTimeout"</span>&gt;</span>50000000<span class="tag">&lt;/<span class="title">str</span>&gt;</span> 
            <span class="tag">&lt;<span class="title">str</span> <span class="attribute">name</span>=<span class="value">"httpReadTimeout"</span>&gt;</span>10000000<span class="tag">&lt;/<span class="title">str</span>&gt;</span> 
           <span class="comment">&lt;!--  &lt;str name="httpBasicAuthUser"&gt;123&lt;/str&gt; 
           &lt;str name="httpBasicAuthPassword"&gt;123&lt;/str&gt; --&gt;</span><span class="comment">&lt;!-- 为了安全可以设置可以进行这些操作的请求的密码只有密码正确的请求才能执行分发操作--&gt;</span>
         <span class="tag">&lt;/<span class="title">lst</span>&gt;</span>  
     <span class="tag">&lt;/<span class="title">requestHandler</span>&gt;</span>
</pre></td></tr></table></figure>

<hr>
<h1 id="6-solr-http-">6.一个请求solr服务的http请求的执行顺序</h1>
<blockquote>
<p><a href="http://host_name:port/webapp_name/solrcore_name/someSolrServiceParameters" target="_blank">http://host_name:port/webapp_name/solrcore_name/someSolrServiceParameters</a> </br></p>
</blockquote>
<p>  因为配置了SolrDispatchFilter过滤器所以这个请求肯定会通过这个过滤器的doFilter方法。
  进入到doFilter方法后</br></p>
<p>  1 首先这个过滤器做为一个普通的类他拥有Corecontainer这个容器属性也就是说所有的solrcore实例都在这个类中可以拿到。
      那么这个拿到了什么都好说,并且他做的第一件事情是将这个coreContainer实例保存到了我们的请求中也就是HttpServletRequest对象的内置map属性中了，
      那么通过这个过滤器后我们还可以访问到很多与solr相关的东西
      <code>request.setAttribute(&quot;org.apache.solr.CoreContainer&quot;, cores);</code></br></p>
<p>  2 下一步是根据我们的httpServletRequest中的请求参数得到对应的solr请求对象也就是得到<code>solrQueryRequest</code>
    他是通过一个解析器来得到solrQueryRequest这个实例的在SolrQueryRequest的parse方法中需要传入 
    <code>public SolrQueryRequest parse( SolrCore core, String path, HttpServletRequest req )</code></p>
<p>  3 然后返回一个solrQueryRequest，也就是将httpServletRequest对象中的参数转换成solr容器知道这个请求
  需要什么东西的一个对象，请求什么服务的对象已经构造好了，然后就是构造怎么处理这个请求的一个请求处理器
  这个请求处理器在solrQueryRequest中已经描述出来了，所以只需要在一个集合中根据键值对进行取得就可以了
  这个处理器
  <code>handler = core.getRequestHandler( path );</code>
  在solrcore实例中已经配置好了许多这样的请求处理器只要从中拿一个就可以了。根据参数构造了需要什么样的服务的对象出来，并且针对这个服务的处理器出来了，</p>
<p>  4 下一步就是执行了<code>this.execute( req, handler, solrReq, solrRsp );</code>这一步是处理所有的solr服务的入口，如果想知道solr是怎么实现的一切都从这里开始。</p>
<hr>
<h1 id="7-solr-core-code-">7.solr分布式索引分发的全过程以及中间core code:</h1>
<blockquote>
<p>如何以http请求方式进行主从索引文件同步</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre>&gt; master HTTP 管理 API：
      启用复制， <span class="keyword">http</span>://master_name:port/solr-master/replication?<span class="command"><span class="keyword">command</span>=<span class="title">enablereplication</span></span>
      禁用复制， <span class="keyword">http</span>://master_name:port/solr-master/replication?<span class="command"><span class="keyword">command</span>=<span class="title">disablereplication</span></span>
      备份：     <span class="keyword">http</span>://master_name:port/solr-master/replication?<span class="command"><span class="keyword">command</span>=<span class="title">backup</span></span>

&gt; slave TTTP 管理 API：
      复制索引，        <span class="keyword">http</span>://slave_host:port/solr-slave/replication?<span class="command"><span class="keyword">command</span>=<span class="title">fetchindex</span></span>
      终止索引的复制，  <span class="keyword">http</span>://slave_host:port/solr-slave/replication?<span class="command"><span class="keyword">command</span>=<span class="title">abortfetch</span></span>
      启动轮询复制索引，<span class="keyword">http</span>://slave_host:port/solr-slave/replication?<span class="command"><span class="keyword">command</span>=<span class="title">enablepoll</span></span>
      禁用轮询复制索引，<span class="keyword">http</span>://slave_host:port/solr-slave/replication?<span class="command"><span class="keyword">command</span>=<span class="title">disablepoll</span></span>
      索引详细，        <span class="keyword">http</span>://slave_host:port/solr-slave/replication?<span class="command"><span class="keyword">command</span>=<span class="title">details</span> </span>
    
&gt; public TTTP 管理 API:
      取索引版本号，    <span class="keyword">http</span>://host_name:port/solr-slave/replication?<span class="command"><span class="keyword">command</span>=<span class="title">indexversion</span></span>
</pre></td></tr></table></figure>


<blockquote>
<p>分布式处理的关键类:</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>org<span class="preprocessor">.apache</span><span class="preprocessor">.solr</span><span class="preprocessor">.handler</span><span class="preprocessor">.ReplicationHandler</span><span class="preprocessor">.java</span>
org<span class="preprocessor">.apache</span><span class="preprocessor">.solr</span><span class="preprocessor">.handler</span><span class="preprocessor">.SnapPuller</span><span class="preprocessor">.java</span>
SnapPuller的内部类:SnapPuller$FileFetcher
</pre></td></tr></table></figure>

<blockquote>
<p>browser:发送get请求</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="keyword">http</span>://slave_host:port/solr-slave/replication?<span class="command"><span class="keyword">command</span>=<span class="title">fetchindex</span></span>
</pre></td></tr></table></figure>

<p>经过SolrDispatchFilter过滤器的doFilter方法然后得到SolrQueryRequest对象和SolrRequestHandler对象实例，</br>
让后调用<code>this.execute( req, handler, solrReq, solrRsp );</code>方法进入ReplicationHandler内部的HandleRequest</br>这个发放是从父类继承过滤在父类中调用了子类的HandlRequestBody方法然后开始处理分布式相关的操作</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre></td><td class="code"><pre><span class="annotation">@Override</span>
  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequestBody</span>(SolrQueryRequest req, SolrQueryResponse rsp) <span class="keyword">throws</span> Exception {
    rsp.setHttpCaching(<span class="keyword">false</span>);
    <span class="keyword">final</span> SolrParams solrParams = req.getParams();
    String command = solrParams.get(COMMAND);
    <span class="keyword">if</span> (command == <span class="keyword">null</span>) {
      rsp.add(STATUS, OK_STATUS);
      rsp.add(<span class="string">"message"</span>, <span class="string">"No command"</span>);
      <span class="keyword">return</span>;
    }
    <span class="comment">// This command does not give the current index version of the master</span>
    <span class="comment">// It gives the current 'replicateable' index version</span>
   <span class="keyword">if</span> (command.equals(CMD_INDEX_VERSION)) {
      IndexCommit commitPoint = indexCommitPoint;  <span class="comment">// make a copy so it won't change</span>
      <span class="keyword">if</span> (commitPoint != <span class="keyword">null</span> && replicationEnabled.get()) {
        <span class="comment">//</span>
        <span class="comment">// There is a race condition here.  The commit point may be changed / deleted by the time</span>
        <span class="comment">// we get around to reserving it.  This is a very small window though, and should not result</span>
        <span class="comment">// in a catastrophic failure, but will result in the client getting an empty file list for</span>
        <span class="comment">// the CMD_GET_FILE_LIST command.</span>
        <span class="comment">//</span>
        core.getDeletionPolicy().setReserveDuration(commitPoint.getVersion(), reserveCommitDuration);
        rsp.add(CMD_INDEX_VERSION, commitPoint.getVersion());
        rsp.add(GENERATION, commitPoint.getGeneration());
      } <span class="keyword">else</span> {
        <span class="comment">// This happens when replication is not configured to happen after startup and no commit/optimize</span>
        <span class="comment">// has happened yet.</span>
        rsp.add(CMD_INDEX_VERSION, <span class="number">0</span>L);
        rsp.add(GENERATION, <span class="number">0</span>L);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(CMD_GET_FILE)) {
      getFileStream(solrParams, rsp);
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(CMD_GET_FILE_LIST)) {
      getFileList(solrParams, rsp);
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(CMD_BACKUP)) {
      doSnapShoot(<span class="keyword">new</span> ModifiableSolrParams(solrParams), rsp,req);
      rsp.add(STATUS, OK_STATUS);
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(CMD_FETCH_INDEX)) {
      String masterUrl = solrParams.get(MASTER_URL);
      <span class="keyword">if</span> (!isSlave && masterUrl == <span class="keyword">null</span>) {
        rsp.add(STATUS,ERR_STATUS);
        rsp.add(<span class="string">"message"</span>,<span class="string">"No slave configured or no 'masterUrl' Specified"</span>);
        <span class="keyword">return</span>;
      }
      <span class="keyword">final</span> SolrParams paramsCopy = <span class="keyword">new</span> ModifiableSolrParams(solrParams);
      <span class="keyword">new</span> Thread() {
        <span class="annotation">@Override</span>
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {
          doFetch(paramsCopy);<span class="javadoc">/** 进行关键的处理*/</span>
        }
      }.start();
      rsp.add(STATUS, OK_STATUS);
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(CMD_DISABLE_POLL)) {
      <span class="keyword">if</span> (snapPuller != <span class="keyword">null</span>){
        snapPuller.disablePoll();
        rsp.add(STATUS, OK_STATUS);
      } <span class="keyword">else</span> {
        rsp.add(STATUS, ERR_STATUS);
        rsp.add(<span class="string">"message"</span>,<span class="string">"No slave configured"</span>);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(CMD_ENABLE_POLL)) {
      <span class="keyword">if</span> (snapPuller != <span class="keyword">null</span>){
        snapPuller.enablePoll();
        rsp.add(STATUS, OK_STATUS);
      }<span class="keyword">else</span> {
        rsp.add(STATUS,ERR_STATUS);
        rsp.add(<span class="string">"message"</span>,<span class="string">"No slave configured"</span>);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(CMD_ABORT_FETCH)) {
      <span class="keyword">if</span> (snapPuller != <span class="keyword">null</span>){
        snapPuller.abortPull();
        rsp.add(STATUS, OK_STATUS);
      } <span class="keyword">else</span> {
        rsp.add(STATUS,ERR_STATUS);
        rsp.add(<span class="string">"message"</span>,<span class="string">"No slave configured"</span>);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(CMD_FILE_CHECKSUM)) {
      <span class="comment">// this command is not used by anyone</span>
      getFileChecksum(solrParams, rsp);
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(CMD_SHOW_COMMITS)) {
      rsp.add(CMD_SHOW_COMMITS, getCommits());
    } <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(CMD_DETAILS)) {
      rsp.add(CMD_DETAILS, getReplicationDetails(solrParams.getBool(<span class="string">"slave"</span>,<span class="keyword">true</span>)));
      RequestHandlerUtils.addExperimentalFormatWarning(rsp);
    } <span class="keyword">else</span> <span class="keyword">if</span> (CMD_ENABLE_REPL.equalsIgnoreCase(command)) {
      replicationEnabled.set(<span class="keyword">true</span>);
      rsp.add(STATUS, OK_STATUS);
   } <span class="keyword">else</span> <span class="keyword">if</span> (CMD_DISABLE_REPL.equalsIgnoreCase(command)) {
     replicationEnabled.set(<span class="keyword">false</span>);
     rsp.add(STATUS, OK_STATUS);
   }
  }
</pre></td></tr></table></figure>

<hr>
<h1 id="7-solrj-solrcore-api-">7.solrj提供了控制solrcore容器的api包括范围配置信息等</h1>
<blockquote>
<p>SolrRequest 的子类</p>
</blockquote>
<p> 用于控制一个web应用中的coreContainer容器如查询,添加实例,添加文档等对应到的有SolrResponse</p>
<hr>
<h1 id="-">参考</h1>
<p><a href="http://blog.csdn.net/zyb243380456/article/details/7225768" target="_blank">solr 应用全面解析，简单的应用，多实例，分布式索引分发,如何在客户端配置注册多实例</a></p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/solr/">solr</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/solr/">solr</a>
</div>



<div class="article-share" id="share">

  

	<!-- JiaThis Button BEGIN -->
	<script type="text/javascript">
	var jiathis_config = {data_track_clickback:'true'};
	</script>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1893583" charset="utf-8"></script>
	<!-- JiaThis Button END -->




</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/03/07/mapinfo-g-1/" title="mapinfo...">
  <strong>PREVIOUS:</strong><br/>
  <span>
  mapinfo...</span>
</a>
</div>


<div class="next">
<a href="/2014/03/06/solr-g-2/"  title="solr初读-2">
 <strong>NEXT:</strong><br/> 
 <span>solr初读-2
</span>
</a>
</div>

</nav>

	
<section class="comment">
	
	
	<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"youfei"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = 'http://static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
			|| document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
		</script>
	<!-- Duoshuo Comment END -->
	
	
	
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-solr-"><span class="toc-number">1.</span> <span class="toc-text">1.solr认识</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-web-solr-"><span class="toc-number">2.</span> <span class="toc-text">2.快速的为你的web应用提供solr全文检索服务</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tomcat-uriencoding"><span class="toc-number">2.1.</span> <span class="toc-text">Tomcat URIEncoding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-jar-"><span class="toc-number">2.2.</span> <span class="toc-text">需要的jar:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-solr-home-"><span class="toc-number">2.3.</span> <span class="toc-text">的主要目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#solr-servlet-solr-home-"><span class="toc-number">2.4.</span> <span class="toc-text">solr如何与servlet容器相关联[配置solr.home]</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#3-solr-"><span class="toc-number">3.</span> <span class="toc-text">3.solr相关包的概要</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-jar-"><span class="toc-number">3.1.</span> <span class="toc-text">首先需要的jar包有:</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#apache-solr-core-3-2-0-jar-"><span class="toc-number">3.1.1.</span> <span class="toc-text">apache-solr-core-3.2.0.jar;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#org-apache-solr-highlight"><span class="toc-number">3.1.2.</span> <span class="toc-text">org.apache.solr.highlight</span></a></li></ol></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#4-corecontainer-"><span class="toc-number">4.</span> <span class="toc-text">4.如何配置多实例的CoreContainer容器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-solr-"><span class="toc-number">5.</span> <span class="toc-text">5.分布式solr服务的搭建配置方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-solr-http-"><span class="toc-number">6.</span> <span class="toc-text">6.一个请求solr服务的http请求的执行顺序</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-solr-core-code-"><span class="toc-number">7.</span> <span class="toc-text">7.solr分布式索引分发的全过程以及中间core code:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-solrj-solrcore-api-"><span class="toc-number">8.</span> <span class="toc-text">7.solrj提供了控制solrcore容器的api包括范围配置信息等</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-"><span class="toc-number">9.</span> <span class="toc-text">参考</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Bootstrap/" title="Bootstrap">Bootstrap<sup>1</sup></a></li>
		
			<li><a href="/categories/Design/" title="Design">Design<sup>1</sup></a></li>
		
			<li><a href="/categories/Github Blog/" title="Github Blog">Github Blog<sup>3</sup></a></li>
		
			<li><a href="/categories/Golang/" title="Golang">Golang<sup>5</sup></a></li>
		
			<li><a href="/categories/Java/" title="Java">Java<sup>1</sup></a></li>
		
			<li><a href="/categories/Mongo/" title="Mongo">Mongo<sup>2</sup></a></li>
		
			<li><a href="/categories/mapinfo/" title="mapinfo">mapinfo<sup>1</sup></a></li>
		
			<li><a href="/categories/rabbit/" title="rabbit">rabbit<sup>1</sup></a></li>
		
			<li><a href="/categories/scala/" title="scala">scala<sup>1</sup></a></li>
		
			<li><a href="/categories/solr/" title="solr">solr<sup>2</sup></a></li>
		
			<li><a href="/categories/svg/" title="svg">svg<sup>1</sup></a></li>
		
			<li><a href="/categories/比较杂乱/" title="比较杂乱">比较杂乱<sup>2</sup></a></li>
		
			<li><a href="/categories/生活杂记/" title="生活杂记">生活杂记<sup>1</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Bootstrap/" title="Bootstrap">Bootstrap<sup>1</sup></a></li>
		
			<li><a href="/tags/Design/" title="Design">Design<sup>1</sup></a></li>
		
			<li><a href="/tags/Git Page/" title="Git Page">Git Page<sup>1</sup></a></li>
		
			<li><a href="/tags/Java/" title="Java">Java<sup>1</sup></a></li>
		
			<li><a href="/tags/Mongo/" title="Mongo">Mongo<sup>2</sup></a></li>
		
			<li><a href="/tags/golang/" title="golang">golang<sup>5</sup></a></li>
		
			<li><a href="/tags/hexo/" title="hexo">hexo<sup>5</sup></a></li>
		
			<li><a href="/tags/mapinfo/" title="mapinfo">mapinfo<sup>1</sup></a></li>
		
			<li><a href="/tags/rabbit/" title="rabbit">rabbit<sup>1</sup></a></li>
		
			<li><a href="/tags/scala/" title="scala">scala<sup>1</sup></a></li>
		
			<li><a href="/tags/solr/" title="solr">solr<sup>2</sup></a></li>
		
			<li><a href="/tags/svg/" title="svg">svg<sup>1</sup></a></li>
		
			<li><a href="/tags/比较杂乱/" title="比较杂乱">比较杂乱<sup>2</sup></a></li>
		
			<li><a href="/tags/生活杂记/" title="生活杂记">生活杂记<sup>1</sup></a></li>
		
		</ul>
</div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/Bootstrap/" style="font-size: 10.00px;">Bootstrap</a><a href="/tags/Design/" style="font-size: 10.00px;">Design</a><a href="/tags/Git Page/" style="font-size: 10.00px;">Git Page</a><a href="/tags/Java/" style="font-size: 10.00px;">Java</a><a href="/tags/Mongo/" style="font-size: 15.00px;">Mongo</a><a href="/tags/golang/" style="font-size: 20.00px;">golang</a><a href="/tags/hexo/" style="font-size: 20.00px;">hexo</a><a href="/tags/mapinfo/" style="font-size: 10.00px;">mapinfo</a><a href="/tags/rabbit/" style="font-size: 10.00px;">rabbit</a><a href="/tags/scala/" style="font-size: 10.00px;">scala</a><a href="/tags/solr/" style="font-size: 15.00px;">solr</a><a href="/tags/svg/" style="font-size: 10.00px;">svg</a><a href="/tags/比较杂乱/" style="font-size: 15.00px;">比较杂乱</a><a href="/tags/生活杂记/" style="font-size: 10.00px;">生活杂记</a>
    </div>
  </div>


  <div class="tagslist">
	<p class="asidetitle">我的微博</p>
	<iframe id="sina_widget_1656357677" style="width:100%; height:500px;" frameborder="0" scrolling="no" src="http://v.t.sina.com.cn/widget/widget_blog.php?uid=1656357677&height=500&skin=wd_02&showpic=1"></iframe>
</div>

  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
     <li><a href="http://hongbinzuo.github.io/" title="Hongbin Zuo's Blog">Hongbin Zuo</a></li>
     <li><a href="http://blog.csdn.net/zyb243380456/" title="zyb243380456的专栏">zyb243380456的专栏</a></li>
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> 
		
		</br> © 2014 <a href="http://youfei.github.io" target="_blank" title="fei you">fei you</a>
		<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1000271340'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1000271340%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
		
		</p>
</div>
	
	
	</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"null"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
